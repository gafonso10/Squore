<!DOCTYPE html>
<html>
<head>
    <!-- https://raw.githubusercontent.com/obbimi/Squore/master/docs/cast/index.html -->
    <!-- https://obbimi.github.io/Squore/cast/index.html -->
    <!-- https://developers.google.com/cast/docs/caf_receiver/advanced#creating-a-customized-receiver-app -->
    <!-- https://codelabs.developers.google.com/codelabs/cast-receiver/#0 -->
    <!--
    npm install -g http-server
    npm install -g ngrok
    -->
    <meta charset="utf-8" />
    <title>Score Test</title>
    <script type="text/javascript"
            src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js">
    </script>
    <script type="text/javascript" src="cast_dummy.js"></script>

    <script
            src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="board.css" />
</head>
<body>
<div id="dummy_messages" style="display: none; position: absolute;">
    <button value="send" onclick="sendDummyMessages()">Dummy</button>
</div>
<div id="squoreboard_root_view">
    <div class="gui_element namebutton"      id="txt_player1">
        <span class="name">Shawn</span>
    </div>
    <div class="gui_element namebutton"      id="txt_player2">
        <span class="name">Casey</span>
    </div>
    <div class="gui_element gameswonbutton"  id="btn_gameswon1">
        <span class="name">0</span>
    </div>
    <div class="gui_element gameswonbutton"  id="btn_gameswon2">
        <span class="name">0</span>
    </div>
    <div class="gui_element scorebutton"     id="btn_score1">
        <span class="digits">11</span>
        <div class="gui_element sidebutton"  id="btn_side1">
            <span class="side">L</span>
        </div>
    </div>
    <div class="gui_element scorebutton"     id="btn_score2">
        <span class="digits">9</span>
        <div class="gui_element sidebutton"  id="btn_side2">
            <span class="side">R?</span>
        </div>
    </div>
    <div id="gameBallMessage" class="gui_element message">
        <span>Game ball</span>
    </div>
    <div id="btn_timer" class="gui_element message">
        <span>01:30</span>
    </div>
    <div id="callDecisionMessage1" class="gui_element message callDecisionMessage">
        <span>Stroke</span>
    </div>
    <div id="callDecisionMessage2" class="gui_element message callDecisionMessage">
        <span>No let</span>
    </div>
</div>


<script type="text/javascript">
var CountDownTimer = {
    m_iSecondsLeft : 0,
    m_iInterval    : null,
    show : function(iStartAt) {
        clearInterval(CountDownTimer.m_iInterval);
        $('#btn_timer').show();
        this.m_iSecondsLeft = iStartAt;
        this.m_iInterval    = setInterval(function() {
          CountDownTimer.m_iSecondsLeft--;
          $('#btn_timer').html(CountDownTimer.m_iSecondsLeft); // TODO: min:sec format

          // If the count down is finished, write some text
          if (CountDownTimer.m_iSecondsLeft <= 0) {
            clearInterval(CountDownTimer.m_iInterval);
            $('#btn_timer').html("Time!"); // TODO: from message from app
          }
        }, 1000);
    },
    cancel : function() {
        clearInterval(CountDownTimer.m_iInterval);
        $('#btn_timer').hide();
    }
}


var CHANNEL_B = 'urn:x-cast:com.doubleyellow.badminton';
function handleMessage(customEvent)
{
//console.log(customEvent);
    var data = customEvent.data;
    if ( data.id ) {
console.log(data.id + '.'  + (data.property || 'text') + ' = ' + data.value);
        if ( (! data.property) || data.property == 'text' ) {
            $('#' + data.id + ' > span').html(data.value);
        } else {
            $('#' + data.id ).css(data.property, data.value);
        }
    }
    if ( data.func ) {
console.log(data.func);
        eval(data.func);
        //Helper[data.func].call(Helper, data.arg1);
    }
}

window.onload = function ()
{
    var ctx     = cast.framework.CastReceiverContext.getInstance();
//console.log('ctx:' + ctx);
    var options = new cast.framework.CastReceiverOptions();           // https://developers.google.com/cast/docs/reference/caf_receiver/cast.framework.CastReceiverOptions

    // This is used to send data back to the senders apps.
    options.customNamespaces = Object.assign({});
    options.customNamespaces[CHANNEL_B] = cast.framework.system.MessageType.JSON;
//console.log('options:' + options);
//console.log(options);

    ctx.addCustomMessageListener(CHANNEL_B, handleMessage);

    ctx.start(options);

    CountDownTimer.cancel();
}
    </script>
</body>
</html>